<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Parking Receipt</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { font-family: Arial, sans-serif; padding: 30px; }
    h2 { text-align: center; margin-bottom: 25px; }
    table { margin: 0 auto; }
    .btn-print { display: block; margin: 20px auto; }
  </style>
</head>
<body>

  <h2>Parking Receipt</h2>

  <div id="receiptContent" class="text-center">
    <table class="table table-borderless text-start mx-auto" style="max-width: 400px;">
      <tr><th>Vehicle Number:</th><td>{{ receipt.vehicle_number }}</td></tr>
      <tr><th>Slot:</th><td>{{ receipt.slot }}</td></tr>
      <tr><th>Entry Time:</th><td>{{ receipt.entry_time }}</td></tr>
      <tr><th>Exit Time:</th><td>{{ receipt.exit_time }}</td></tr>
      <tr><th>Total Hours:</th><td>{{ receipt.hours }}</td></tr>
      <tr><th>Charge:</th><td>‚Çπ{{ receipt.amount }}</td></tr>
    </table>

    {% if not receipt.paid %}
      <button type="button" class="btn btn-primary mt-3"
              onclick="confirmPayment('{{ receipt.slot }}')">Confirm Payment</button>
    {% else %}
      <button type="button" class="btn btn-success mt-3" disabled>Payment Confirmed ‚úì</button>
    {% endif %}

    <button id="printBtn" class="btn btn-secondary btn-print">üñ®Ô∏è Print / Download PDF</button>
  </div>

  <script>
  function confirmPayment(slotCode) {
    console.log('Confirm payment clicked for slot:', slotCode);
    if (confirm('Are you sure you want to confirm payment?')) {
      console.log('User confirmed, sending request...');
      // Send payment confirmation to server
      fetch(`/confirm_payment/${slotCode}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        }
      })
      .then(response => {
        console.log('Response status:', response.status);
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        return response.json();
      })
      .then(data => {
        console.log('Response data:', data);
        if (data.success) {
          alert('Payment confirmed successfully! Slot is now available.');
          console.log('Redirecting to receipt page...');
          // Force redirect using top-level window (escapes modal)
          window.top.location.href = `/receipt_by_slot/${slotCode}`;
        } else {
          alert(data.message || 'Payment confirmation failed. Please try again.');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('An error occurred. Please try again.');
      });
    } else {
      console.log('User cancelled payment confirmation');
    }
  }

  document.addEventListener("DOMContentLoaded", function() {
    const printBtn = document.getElementById("printBtn");

    printBtn.addEventListener("click", function() {
      window.print();
    });
  });
  </script>

</body>
</html>